---
layout: post
title: MYSQL主备复制，如何计算备库延时时间？备库延时大的原因是什么？
category: mysql
tags: [mysql]
excerpt: MYSQL主备复制，如何计算备库延时时间？备库延时大的原因是什么？
keywords: mysql,主备复制,主从复制,主备复制延时,主从复制延时
---

### 一、备库延时时间的计算方式
你可以在备库上执行 `show slave status` 命令，它的返回结果里面会显示 `seconds_behind_master`，用于表示当前备库延迟了多少秒。

`seconds_behind_master` 的计算方法是这样的：

1. 每个事务的 binlog 里面都有一个时间字段，用于记录主库上写入的时间；
2. 备库取出当前正在执行的事务的时间字段的值，计算它与当前系统时间的差值，得到 seconds_behind_master。

可以看到，其实 seconds_behind_master 这个参数计算的就是 T3-T1。所以，我们可以用 seconds_behind_master 来作为主备延迟的值，这个值的时间精度是秒。

你可能会问，如果主备库机器的系统时间设置不一致，会不会导致主备延迟的值不准？

其实不会的。因为，备库连接到主库的时候，会通过执行 `SELECT UNIX_TIMESTAMP()` 函数来获得当前主库的系统时间。如果这时候发现主库的系统时间与自己不一致，备库在执行 `seconds_behind_master` 计算的时候会自动扣掉这个差值。

### 二、备库延时的来源
* #### 1.备库机器性能差，多个备库实例在一台机器上

  首先，有些部署条件下，备库所在机器的性能要比主库所在的机器性能差。
一般情况下，有人这么部署时的想法是，反正备库没有请求，所以可以用差一点儿的机器。或者，他们会把 20 个主库放在 4 台机器上，而把备库集中在一台机器上。

  其实我们都知道，更新请求对 IOPS 的压力，在主库和备库上是无差别的。所以，做这种部署时，一般都会将备库设置为“非双 1”的模式。
但实际上，更新过程中也会触发大量的读操作。所以，当备库主机上的多个备库都在争抢资源的时候，就可能会导致主备延迟了。

  当然，这种部署现在比较少了。因为主备可能发生切换，备库随时可能变成主库，所以主备库选用相同规格的机器，并且做对称部署，是现在比较常见的情况。
  **`解决方案：`**
  对称部署

> **`但是，做了对称部署以后，还可能会有延迟。这是为什么呢？`**

* #### 2.备库的压力大

  一般的想法是，主库既然提供了写能力，那么备库可以提供一些读能力。或者一些运营后台需要的分析语句，不能影响正常业务，所以只能在备库上跑。

  由于主库直接影响业务，大家使用起来会比较克制，反而忽视了备库的压力控制。结果就是，备库上的查询耗费了大量的 CPU 资源，影响了同步速度，造成主备延迟。
  
  **`解决方案：`**
  这种情况，我们一般可以这么处理：

  1. 一主多从。除了备库外，可以多接几个从库，让这些从库来分担读的压力。
  2. 通过 binlog 输出到外部系统，比如 Hadoop 这类系统，让外部系统提供统计类查询的能力。

  其中，一主多从的方式大都会被采用。因为作为数据库系统，还必须保证有定期全量备份的能力。而从库，就很适合用来做备份。

> **`采用了一主多从，保证备库的压力不会超过主库，还有什么情况可能导致主备延迟吗？`**

* #### 3.大事务

  **大事务** 这种情况很好理解。因为主库上必须等事务执行完成才会写入 binlog，再传给备库。所以，如果一个主库上的语句执行 10 分钟，那这个事务很可能就会导致从库延迟 10 分钟。

  不知道你所在公司的 DBA 有没有跟你这么说过：不要一次性地用 delete 语句删除太多数据。其实，这就是一个典型的大事务场景。

  比如，一些归档类的数据，平时没有注意删除历史数据，等到空间快满了，业务开发人员要一次性地删掉大量历史数据。同时，又因为要避免在高峰期操作会影响业务（至少有这个意识还是很不错的），所以会在晚上执行这些大量数据的删除操作。
  **`解决方案：开发同学和DBA同学开发过程中人为控制，尽量减少大事务`**
  
 
  **另一种典型的大事务场景，就是大表 DDL**

>  **`如果主库上也不做大事务了，还有什么原因会导致主备延迟吗？`**

* #### 4.备库的并行复制能力。
  主库是多线程执行，而备库确实单线程备份，在这种情况下，有可能会造成备库的复制跟不上主库，这是就需要进行并行复制，而mysql又有几种不同的并行复制的策略，不同的策略之间又有各有优缺点，所以选择正确的并行复制策略对备库的并行复制能力的提升，也很是关键。
   **`解决方案：`**
  对于备库的并行复制，可以转至：[MySQL备库的并行复制策略，我们改选择哪种并行复制策略？如何调优？](www.baidu.com) 查看。





















